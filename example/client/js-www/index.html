<!DOCTYPE html>
<meta charset="utf-8"/>
<html>
<head>
  <title>protobufCARTATest</title>

  <!-- <script src="https://cdn.rawgit.com/dcodeIO/protobuf.js/6.8.6/dist/protobuf.js"></script> -->
  <!-- See: https://github.com/dcodeIO/long.js -->
  <script src="lib/dcodeIO/long.min.js"></script>
  <!-- See: https://github.com/dcodeIO/bytebuffer.js -->
  <script src="lib/dcodeIO/bytebuffer.min.js"></script>
  <!-- See: https://github.com/dcodeIO/protobuf.js -->
  <script src="lib/dcodeIO/protobuf.min.js"></script>
  <!-- See: https://github.com/hsk81/protobuf-rpc-js -->
  <script src="lib/dcodeIO/protobuf-rpc.min.js"></script>
  <script>


    // protobuf.load("../protocol/lm.helloworld.proto", function (err, root) {
    // // protobuf.load({root:"/data/NamespaceUpdated/CARTAvis/carta/cpp/core/Data/Image/", file:"lm.helloworld.proto"}, (err, root) => {
    //   if (err) throw err;
    //   console.log("ROOT: ", root);
    //   HelloWorld = root.lookupType("lm.helloworld");
    //   console.log("HelloWorld", HelloWorld);
    //   helloWorld = HelloWorld.create({ id : "101", str : "hello" });
    //   console.log('helloWorld: ', helloWorld);
    //   buffer = HelloWorld.encode(helloWorld).finish();
    //   testDecode = HelloWorld.decode(buffer);
    //   console.log("Test encoding", buffer);
    //   console.log("Test decoding", testDecode);
    //
    // });
    //
    // function blobToArrayBuffer(blob) {
    //   var fileReader = new FileReader();
    //   return new Promise(function(resolve, reject) {
    //      fileReader.onload = resolve;
    //      fileReader.onerror = reject;
    //      fileReader.readAsArrayBuffer(blob);
    //   });
    // }
    //
    // function output(message) {
    //     var output = document.getElementById("output");
    //     output.innerHTML = output.innerHTML + message + "\n";
    // }
    //
    // var socket = null;
    // function sendMessage() {
    //   if ( socket != null )
    //   {
    //     // socket.send( "testProtoBuf" );
    //     socket.send(buffer.buffer.slice(buffer.byteOffset, buffer.byteOffset + buffer.length));
    //     // console.log( "string sent" );
    //     console.log( "binary sent" );
    //   }
    // }
    //
    // window.onload = function() {
    //   var baseUrl = "ws://localhost:8089";
    //
    //   output("Connecting to WebSocket server at " + baseUrl + ".");
    //   socket = new WebSocket(baseUrl);
    //
    //   // Setting binaryType to accept received binary as either 'blob' or 'arraybuffer'
    //   socket.binaryType = 'arraybuffer';
    //
    //   socket.onclose = function() {
    //     console.error("web socket closed");
    //   };
    //   socket.onerror = function(error) {
    //     console.error("web socket error: " + error);
    //   };
    //   socket.onopen = function() {
    //     output("WebSocket connected.");
    //   }
    //   socket.onmessage = function(msg) {
    //     console.log("Received message:", msg.data);
    //     var u8 = new Uint8Array(msg.data);
    //     console.log('u8: ', u8);
    //     var helloWorld = HelloWorld.decode(u8);
    //     console.log('Decoding result:', helloWorld);
    //
    //
    //
    //     // blobToArrayBuffer(msg.data).then(buffer => {
    //       // Don't know why going through the explicitOriginalTarget
    //       // console.log('buffer: ', buffer.explicitOriginalTarget.result);
    //
    //     //   var u8 = new Uint8Array(buffer.explicitOriginalTarget.result);
    //     //   console.log('u8: ', u8);
	  //     //   var helloWorld = HelloWorld.decode(u8);
    //     //   console.log('Decoding result:', helloWorld);
    //     // });
    //     // use the JS API to convert to the ArrayBuffer from BLOB.
    //     // var fileReader = new FileReader();
    //     // fileReader.onload = (event) => {
    //     //   let arraybuf = this.result;
    //       // };
    //     // fileReader.readAsArrayBuffer(msg.data);
    //     // console.log('Buffer converted: ', arraybuf);
    //     // var helloWorld = HelloWorld.decode(arraybuf);
    //     // console.log('Decoding result:', helloWorld);
    //
    //   }
    // }
    // //END SETUP
    </script>
    <!-- //   <style type="text/css">
    //     html {
    //         height: 100%;
    //         width: 100%;
    //     }
    //     #input {
    //         width: 400px;
    //         margin: 0 10px 0 0;
    //     }
    //     #send {
    //         width: 90px;
    //         margin: 0;
    //     }
    //     #output {
    //         width: 500px;
    //         height: 300px;
    //     }
    // </style> -->
</head>
<body>
  <script>
    //BEGIN SETUP
    var HelloWorld;
    var helloWorld;
    var buffer, testDecode;

    var defer = function (fn, ms) {
        return function () {
            return setTimeout(fn, ms||0);
        }
    };

    var SYSTEM = {
        Api: (function () {
            var factory = dcodeIO.ProtoBuf.loadProtoFile({
                root: 'protocol', file: 'lm.helloworld.proto'
            });

            return factory.build();
        }()),

        Service: function (service_cls, opts) {
            return dcodeIO.ProtoBuf.Rpc(service_cls, opts);
        },

        Transport: dcodeIO.ProtoBuf.Rpc.Transport
    };

    var SERVICE = {
        Lm: (function () {
            return SYSTEM.Service(SYSTEM.Api.Lm.lm_Service, {
                url: 'ws://localhost:8089'
            });
        }())
    };

    SERVICE.Lm.transport.socket.onopen = defer(function () {
        var sub_hello = new SYSTEM.Api.Lm.HelloworldRequest({
            id: 101,
            str: "hello"
        });
        console.log("WebSocket connected.");

        SERVICE.Lm.sub(sub_hello, function (err, sub_res) {
            console.log('[on:sub]', sub_hello, sub_res, err);
        });
    });
  </script>
  <!-- <textarea id="output"></textarea><br />
  <button onClick="sendMessage();">Send</button> -->
</body>
</html>
