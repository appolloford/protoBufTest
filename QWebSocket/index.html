<!DOCTYPE html>
<meta charset="utf-8"/>
<html>
<head>
  <title>protobufCARTATest</title>

  <script src="https://cdn.rawgit.com/dcodeIO/protobuf.js/6.8.6/dist/protobuf.js"></script>
  <script>
    //BEGIN SETUP
    var HelloWorld;
    var helloWorld;
    var buffer, testDecode;

    protobuf.load("./lm.helloworld.proto", function (err, root) {
    // protobuf.load({root:"/data/NamespaceUpdated/CARTAvis/carta/cpp/core/Data/Image/", file:"lm.helloworld.proto"}, (err, root) => {
      if (err) throw err;
      console.log("ROOT: ", root);
      HelloWorld = root.lookupType("lm.helloworld");
      console.log("HelloWorld", HelloWorld);
      helloWorld = HelloWorld.create({ id : "1", str : "hello" });
      console.log('helloWorld: ', helloWorld);
      buffer = HelloWorld.encode(helloWorld).finish();
      testDecode = HelloWorld.decode(buffer);
      console.log("Test encoding", buffer);
      console.log("Test decoding", testDecode);

    });

    function blobToArrayBuffer(blob) {
      var fileReader = new FileReader();
      return new Promise(function(resolve, reject) {
         fileReader.onload = resolve;
         fileReader.onerror = reject;
         fileReader.readAsArrayBuffer(blob);
      });
    }

    function output(message) {
        var output = document.getElementById("output");
        output.innerHTML = output.innerHTML + message + "\n";
    }

    var socket = null;
    function sendMessage() {
      if ( socket != null )
      {
        socket.send( "testProtoBuf" );
        console.log( "string sent" );
      }
    }

    window.onload = function() {
      var baseUrl = "ws://127.0.0.1:4317";

      output("Connecting to WebSocket server at " + baseUrl + ".");
      socket = new WebSocket(baseUrl);

      socket.onclose = function() {
        console.error("web socket closed");
      };
      socket.onerror = function(error) {
        console.error("web socket error: " + error);
      };
      socket.onopen = function() {
        output("WebSocket connected.");
      }
      socket.onmessage = function(msg) {
        console.log("Received message:", msg.data);
        blobToArrayBuffer(msg.data).then(buffer => {
          console.log('buffer: ', buffer.explicitOriginalTarget.result);
          var u8 = new Uint8Array(buffer.explicitOriginalTarget.result);
          console.log('u8: ', u8);
	        var helloWorld = HelloWorld.decode(u8);
          console.log('Decoding result:', helloWorld);
        });
        // use the JS API to convert to the ArrayBuffer from BLOB.
        // var fileReader = new FileReader();
        // fileReader.onload = (event) => {
        //   let arraybuf = this.result;
          // };
        // fileReader.readAsArrayBuffer(msg.data);
        // console.log('Buffer converted: ', arraybuf);
        // var helloWorld = HelloWorld.decode(arraybuf);
        // console.log('Decoding result:', helloWorld);

      }
    }
    //END SETUP
    </script>
      <style type="text/css">
        html {
            height: 100%;
            width: 100%;
        }
        #input {
            width: 400px;
            margin: 0 10px 0 0;
        }
        #send {
            width: 90px;
            margin: 0;
        }
        #output {
            width: 500px;
            height: 300px;
        }
    </style>
</head>
<body>
  <textarea id="output"></textarea><br />
  <button onClick="sendMessage();">Send</button>
</body>
</html>
